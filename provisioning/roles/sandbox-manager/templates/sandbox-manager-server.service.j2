[Unit]
Description=Sandbox Mgr3 Service

[Service]
User={{username}}
TimeoutStartSec=infinity
WorkingDirectory={{install_dir}}/hspc/sandbox-manager/target
{% if sandbox_manager_server_secure_http and not use_custom_ssl_certificates %}
ExecStart=/usr/bin/java \
  -Xms{{sandbox_manager_server_initial_memory}} \
  -Xmx{{sandbox_manager_server_max_memory}} \
  -Dserver.port={{sandbox_manager_server_internal_port}} \
  -Dspring.datasource.url=jdbc:mysql://{{mysql_endpoint}}/{{sandbox_manager_database}} \
  -Dspring.datasource.username={{mysql_user}} \
  -Dspring.datasource.password={{mysql_pass}} \
  -Dspring.jpa.hibernate.ddl-auto=none \
  -Dhspc.platfrom.authorization.port={{auth_server_port}} \
  -Dhspc.platfrom.authorization.context={{auth_server_context}} \
  -Dhspc.platform.api.oauthClientEndpointURL={{auth_server_url}}api/clients \
  -Dhspc.platform.api.oauth2.clientId={{auth_server_client}} \
  -Dhspc.platform.api.oauth2.clientSecret={{auth_server_password}} \
  -Dhspc.platform.api.oauthUser=admin \
  -Dhspc.platform.api.oauthUserPassword=password \
  -Dhspc.platform.api.oauthUserAuthorizationEndpointURL={{persona_auth_server_url}}static/auth/index.html \
  -Dhspc.platform.api.oauthUserInfoEndpointURL={{auth_server_url}}userinfo \
  -Dhspc.platform.api.oauthUserLoginEndpointURL={{auth_server_url}}j_spring_security_check \
  -Dhspc.platform.api.sandboxManagementEndpointURL_1={{api_dstu2_server_base_url}}management/sandbox \
  -Dhspc.platform.api.sandboxManagementEndpointURL_2={{api_dstu2_server_base_url}}management/sandbox \
  -Dhspc.platform.authorization.smart.launchUrl={{persona_auth_server_url}}Launch \
  -Dhspc.platform.messaging.sendEmail=false \
  -Dhspc.platform.api.version1.port={{api_dstu2_server_port}} \
  -Dhspc.platform.api.version1.context={{api_dstu2_server_context}} \
  -DenvInfo.active=true \
  -DsandboxUserUri= \
  -DdefaultServiceUrl={{api_dstu2_server_smart_sandbox_fhir_root_url}} \
  -DbaseServiceUrl_1={{api_dstu2_server_base_url}} \
  -DbaseServiceUrl_2={{api_dstu2_server_base_url}} \
  -DbasePersonaServiceUrl_1={{persona_api_dstu2_server_base_url}} \
  -DbasePersonaServiceUrl_2={{persona_api_dstu2_server_base_url}} \
  -DoauthLogoutUrl={{auth_server_base_url}}/logout \
  -DoauthAuthenticationUrl={{persona_auth_server_base_url}}/static/auth/index.html \
  -DuserManagementUrl= \
  -DhostOrg=smart \
  -Dhspc.platform.defaultSystemRoles={{sandbox_manager_server_defaultSystemRoles}} \
  -Dhspc.platform.defaultSandboxVisibility={{sandbox_manager_server_defaultSandboxVisibility}} \
  -Djavax.net.ssl.trustStore={{install_dir}}/keystore \
  -Djavax.net.ssl.trustStorePassword={{keystore_password}} \
  -jar hspc-sandbox-manager.war
{% else %}
ExecStart=/usr/bin/java \
  -Xms{{sandbox_manager_server_initial_memory}} \
  -Xmx{{sandbox_manager_server_max_memory}} \
  -Dserver.port={{sandbox_manager_server_internal_port}} \
  -Dspring.datasource.url=jdbc:mysql://{{mysql_endpoint}}/{{sandbox_manager_database}} \
  -Dspring.datasource.username={{mysql_user}} \
  -Dspring.datasource.password={{mysql_pass}} \
  -Dspring.jpa.hibernate.ddl-auto=none \
  -Dhspc.platfrom.authorization.port={{auth_server_port}} \
  -Dhspc.platfrom.authorization.context={{auth_server_context}} \
  -Dhspc.platform.api.oauthClientEndpointURL={{auth_server_url}}api/clients \
  -Dhspc.platform.api.oauth2.clientId={{auth_server_client}} \
  -Dhspc.platform.api.oauth2.clientSecret={{auth_server_password}} \
  -Dhspc.platform.api.oauthUser=admin \
  -Dhspc.platform.api.oauthUserPassword=password \
  -Dhspc.platform.api.oauthUserAuthorizationEndpointURL={{persona_auth_server_url}}static/auth/index.html \
  -Dhspc.platform.api.oauthUserInfoEndpointURL={{auth_server_url}}userinfo \
  -Dhspc.platform.api.oauthUserLoginEndpointURL={{auth_server_url}}j_spring_security_check \
  -Dhspc.platform.api.sandboxManagementEndpointURL_1={{api_dstu2_server_base_url}}management/sandbox \
  -Dhspc.platform.api.sandboxManagementEndpointURL_2={{api_dstu2_server_base_url}}management/sandbox \
  -Dhspc.platform.authorization.smart.launchUrl={{persona_auth_server_url}}Launch \
  -Dhspc.platform.messaging.sendEmail=false \
  -Dhspc.platform.api.version1.port={{api_dstu2_server_port}} \
  -Dhspc.platform.api.version1.context={{api_dstu2_server_context}} \
  -DenvInfo.active=true \
  -DsandboxUserUri= \
  -DdefaultServiceUrl={{api_dstu2_server_smart_sandbox_fhir_root_url}} \
  -DbaseServiceUrl_1={{api_dstu2_server_base_url}} \
  -DbaseServiceUrl_2={{api_dstu2_server_base_url}} \
  -DbasePersonaServiceUrl_1={{persona_api_dstu2_server_base_url}} \
  -DbasePersonaServiceUrl_2={{persona_api_dstu2_server_base_url}} \
  -DoauthLogoutUrl={{auth_server_base_url}}/logout \
  -DoauthAuthenticationUrl={{persona_auth_server_base_url}}/static/auth/index.html \
  -DuserManagementUrl= \
  -DhostOrg=smart \
  -Dhspc.platform.defaultSystemRoles={{sandbox_manager_server_defaultSystemRoles}} \
  -Dhspc.platform.defaultSandboxVisibility={{sandbox_manager_server_defaultSandboxVisibility}} \
  -jar hspc-sandbox-manager.war
{% endif %}
Restart=always

[Install]
WantedBy=multi-user.target
